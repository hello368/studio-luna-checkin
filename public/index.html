<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in | Studio Luna Body Sculpting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Lato', sans-serif;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        .gold-border {
            border-color: #D4AF37;
        }

        .gold-text {
            color: #D4AF37;
        }

        .gold-bg {
            background-color: #D4AF37;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Card -->
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border-t-8 gold-border">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Studio Luna Body Sculpting</h1>
            <p class="text-gray-500 text-sm mt-1 uppercase tracking-widest">Client Check-in</p>
        </div>

        <!-- Form -->
        <form id="checkinForm" class="space-y-5">

            <!-- Personal Info -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="name" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 bg-gray-50 p-3 border"
                    placeholder="Jane Doe">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="phone" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 p-3 border"
                        placeholder="(555) 123-4567">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 p-3 border"
                        placeholder="Optional">
                </div>
            </div>

            <!-- Treatment -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Today's Treatment</label>
                <select id="treatment" onchange="updateConsent()"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 p-3 border">
                    <option value="Botox / Dysport">Botox / Dysport</option>
                    <option value="Dermal Fillers">Dermal Fillers</option>
                    <option value="Skin Tightening Facial">Skin Tightening Facial</option>
                    <option value="Microneedling RF">Microneedling RF</option>
                    <option value="Co2 Laser For Acne Treatment">Co2 Laser For Acne Treatment</option>
                    <option value="Co2 Laser Skin Rejuvenation">Co2 Laser Skin Rejuvenation</option>
                    <option value="PRP Treatment">PRP Treatment</option>
                    <option value="Body Contouring Treatment">Body Contouring Treatment</option>
                    <option value="Ultra Sound HIFU Treatment">Ultra Sound HIFU Treatment</option>
                    <option value="Consultation">Consultation</option>
                </select>
            </div>

            <!-- Consent -->
            <div class="border rounded-md p-4 bg-gray-50 h-40 overflow-y-scroll text-xs text-gray-500">
                <p class="font-bold mb-2">CONSENT FOR <span id="consent-treatment-name"
                        class="uppercase">TREATMENT</span></p>
                <div id="consent-text">
                    <!-- Dynamic Text Will Load Here -->
                </div>
                <p class="mt-4 font-bold">Standard Clauses:</p>
                <ul class="list-disc pl-4 mt-1 space-y-1">
                    <li>I understand that individual results may vary.</li>
                    <li>I acknowledge that no guarantees have been made regarding the results.</li>
                    <li>I confirm that I am not pregnant or breastfeeding (if applicable).</li>
                    <li>I agree to follow all post-care instructions provided to me.</li>
                    <li>I understand payment is due at time of service.</li>
                </ul>
            </div>

            <!-- Signature -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Signature</label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg bg-white relative">
                    <canvas id="signature-pad" class="w-full h-40 touch-none"></canvas>
                    <button type="button" id="clear-sig"
                        class="absolute bottom-2 right-2 text-xs text-gray-400 hover:text-red-500 underline">Clear</button>
                </div>
                <p class="text-xs text-gray-400 mt-1">Please sign in the box above.</p>
            </div>

            <!-- Submit -->
            <button type="submit"
                class="w-full gold-bg text-white font-bold py-3 px-4 rounded-md hover:bg-yellow-600 transition duration-300 shadow-lg mt-4">
                CHECK IN
            </button>
        </form>
    </div>

    <script>
        // --- CONSENT FORMS ---
        const consentForms = {
            "default": "I hereby authorize Studio Luna Body Sculpting and its staff to perform the selected procedure. I understand the risks and benefits associated with this treatment.",

            "Botox / Dysport": "I authorize the injection of Botulinum Toxin A (Botox/Dysport). Risks include bruising, swelling, asymmetry, and temporary drooping of eyelids or brows. I understand effects typically last 3-4 months.",

            "Dermal Fillers": "I authorize the injection of Dermal Fillers. Risks include bruising, swelling, lumps/bumps, vascular occlusion (rare), and tissue necrosis. I understand reversing the effect may require Hyaluronidase.",

            "Skin Tightening Facial": "I authorize the Skin Tightening Facial treatment. I understand this may involve radiofrequency or ultrasound energy. Risks include temporary redness, swelling, or mild tenderness.",

            "Microneedling RF": "I authorize Microneedling with Radiofrequency. I understand this involves tiny needles penetrating the skin. Risks include pinpoint bleeding, redness, swelling, scaling, and skin sensitivity for several days.",

            "Co2 Laser For Acne Treatment": "I authorize Fractional CO2 Laser treatment for acne scarring. I understand this is an ablative procedure. Risks include redness, swelling, crusting, oozing, hyperpigmentation, and risk of infection if post-care is not followed.",

            "Co2 Laser Skin Rejuvenation": "I authorize Fractional CO2 Laser Skin Rejuvenation. I understand downtime may be 5-10 days. Risks include prolonged redness, scarring, pigment changes, and infection. I agree to avoid sun exposure strictly.",

            "PRP Treatment": "I authorize Platelet Rich Plasma (PRP) treatment. I understand blood will be drawn from my arm, processed, and re-injected or applied microneedling. Risks include bruising, swelling, and infection at the draw or injection site.",

            "Body Contouring Treatment": "I authorize Body Contouring treatment (e.g., Cavitation, RF, Cryo). I understand this is for fat reduction/skin tightening and is not a weight loss substitute. Risks include redness, bruising, and temporary numbness.",

            "Ultra Sound HIFU Treatment": "I authorize High Intensity Focused Ultrasound (HIFU) treatment. I understand this targets deep tissue layers. Risks include muscle soreness, temporary numbness, bruising, and nerve injury (rare).",

            "Consultation": "I acknowledge this is a consultation only. No procedure will be performed without a separate consent form."
        };

        function updateConsent() {
            const treatment = document.getElementById('treatment').value;
            const text = consentForms[treatment] || consentForms["default"];

            document.getElementById('consent-treatment-name').innerText = treatment;
            document.getElementById('consent-text').innerText = text;
        }

        // Initialize consent text
        updateConsent();

        // --- SIGNATURE PAD ---
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgba(255, 255, 255, 0)',
            penColor: 'rgb(0, 0, 0)'
        });

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        document.getElementById('clear-sig').addEventListener('click', () => signaturePad.clear());

        document.getElementById('checkinForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (signaturePad.isEmpty()) {
                Swal.fire('Signature Required', 'Please sign the consent form.', 'warning');
                return;
            }

            const data = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                treatment: document.getElementById('treatment').value,
                consentText: document.getElementById('consent-text').innerText,
                signature: signaturePad.toDataURL()
            };

            Swal.fire({ title: 'Checking in...', didOpen: () => Swal.showLoading() });

            try {
                const response = await fetch('/api/checkin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    Swal.fire({
                        title: 'All Set!',
                        text: 'Please take a seat. Your provider will be with you shortly.',
                        icon: 'success',
                        confirmButtonColor: '#D4AF37'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    throw new Error('Server error');
                }
            } catch (err) {
                Swal.fire('Error', 'Could not check in. Please try again.', 'error');
            }
        });
    </script>
</body>

</html>